<!--
// SPDX-License-Identifier: BSD-3-Clause
// IPXTransporter – Author: Mark LaPointe <mark@cloudbsd.org>
// Statistics HTML template
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IPXTransporter – Stats</title>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 2rem; background-color: #f4f7f6; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .card { border: 1px solid #ddd; padding: 1rem; border-radius: 4px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .card h3 { margin-top: 0; font-size: 0.9rem; color: #666; }
        .card p { font-size: 1.5rem; margin: 0; font-weight: bold; color: #2c3e50; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; background: white; }
        th, td { border: 1px solid #ddd; padding: 0.75rem; text-align: left; }
        th { background: #ecf0f1; cursor: pointer; user-select: none; }
        th:hover { background: #bdc3c7; }
        #network-graph { width: 100%; height: 400px; border: 1px solid #ddd; margin-top: 1rem; background: white; border-radius: 4px; overflow: hidden; resize: vertical; }
        .admin-only { display: none; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: white; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 300px; border-radius: 8px; }
        .btn { padding: 5px 10px; cursor: pointer; border: none; border-radius: 4px; background: #3498db; color: white; }
        #login-area { position: absolute; top: 2rem; right: 2rem; }
        .btn-danger { background: #e74c3c; }
        .btn:hover { opacity: 0.8; }
        .demo-controls { margin-top: 1rem; padding: 1rem; border: 1px solid #ddd; border-radius: 4px; background: #fffde7; }
        #log-area { margin-top: 1rem; padding: 1rem; border: 1px solid #ddd; border-radius: 4px; background: #2c3e50; color: #ecf0f1; height: 200px; overflow-y: auto; font-family: 'Courier New', Courier, monospace; font-size: 0.85rem; }
        .log-info { color: #2ecc71; }
        .log-error { color: #e74c3c; }
        .log-fatal { color: #e74c3c; font-weight: bold; text-transform: uppercase; }
        .log-timestamp { color: #95a5a6; margin-right: 8px; }
    </style>
</head>
<body>


    <h1>IPXTransporter Statistics</h1>
    <div id="login-area">
        <button id="login-btn" class="btn">Admin Login</button>
        <span id="admin-status" style="margin-left: 10px; font-weight: bold; color: #27ae60; display: none;">Logged In</span>
    </div>
    <div class="grid">
        <div class="card"><h3>Total Packets Received</h3><p id="total-received">{{ .TotalReceived }}</p></div>
        <div class="card"><h3>Total Packets Forwarded</h3><p id="total-forwarded">{{ .TotalForwarded }}</p></div>
        <div class="card"><h3>Total Packets Dropped</h3><p id="total-dropped">{{ .TotalDropped }}</p></div>
        <div class="card"><h3>Total Errors</h3><p id="total-errors">{{ .TotalErrors }}</p></div>
        <div class="card"><h3>Uptime</h3><p id="uptime">{{ .UptimeStr }}</p></div>
        <div class="card"><h3>Listen Address</h3><p id="listen-addr">{{ .ListenAddr }}</p></div>
    </div>

    <h2>Network Topology</h2>
    <div id="network-graph"></div>

    <div id="demo-area" class="demo-controls" style="display: none;">
        <h3>Demo Mode Settings</h3>
        <label>Packet Rate: <input type="number" id="demo-pkt-rate" style="width: 50px;"></label>
        <label>Drop Rate: <input type="number" id="demo-drop-rate" style="width: 50px;"></label>
        <label>Error Rate: <input type="number" id="demo-err-rate" style="width: 50px;"></label>
        <label>Num Peers: <input type="number" id="demo-num-peers" style="width: 50px;"></label>
        <button id="apply-demo" class="btn">Apply</button>
    </div>

    <div id="admin-config-area" class="demo-controls" style="display: none;">
        <h3>Admin Settings</h3>
        <label>Admin Password: <input type="password" id="new-admin-pass" placeholder="New Password" style="width: 150px;"></label>
        <label style="margin-left: 10px;">Network Key: <input type="text" id="admin-network-key" placeholder="Network Key" style="width: 150px;"></label>
        <label style="margin-left: 10px;">Max Children: <input type="number" id="admin-max-children" style="width: 50px;"></label>
        <label style="margin-left: 10px;">Rebalancing: <input type="checkbox" id="admin-rebalance-enabled"></label>
        <label style="margin-left: 10px;">Interval (s): <input type="number" id="admin-rebalance-interval" style="width: 50px;"></label>
        <button id="apply-config" class="btn" style="margin-left: 10px;">Update Settings</button>
        <hr>
        <h3>Manual Peer Addition</h3>
        <label>Peer Address: <input type="text" id="manual-peer-addr" placeholder="e.g. 1.2.3.4:8787" style="width: 200px;"></label>
        <button id="add-peer-btn" class="btn" style="margin-left: 10px;">Add Peer</button>
    </div>

    <h2>System Logs</h2>
    <div id="log-area"></div>

    <h2>Connected Peers (<span id="peer-count">{{ len .Peers }}</span>)</h2>
    <table>
        <thead>
            <tr>
                <th onclick="setSort('id')">ID</th>
                <th onclick="setSort('ip')">IP</th>
                <th onclick="setSort('hostname')">Hostname</th>
                <th>Latency</th>
                <th onclick="setSort('connected')">Connected At</th>
                <th onclick="setSort('last_seen')">Last Seen</th>
                <th onclick="setSort('children')">Children</th>
                <th onclick="setSort('sent_bytes')">Sent (bytes)</th>
                <th onclick="setSort('recv_bytes')">Recv (bytes)</th>
                <th onclick="setSort('sent_pkts')">Sent (pkts)</th>
                <th onclick="setSort('recv_pkts')">Recv (pkts)</th>
                <th onclick="setSort('errors')">Errors</th>
                <th class="admin-only-header" style="display: none;">Actions</th>
            </tr>
        </thead>
        <tbody id="peer-table-body">
        </tbody>
    </table>

    <div id="login-modal" class="modal">
        <div class="modal-content">
            <h3>Admin Login</h3>
            <input type="text" id="username" placeholder="Username" style="width: 100%; margin-bottom: 10px;">
            <input type="password" id="password" placeholder="Password" style="width: 100%; margin-bottom: 10px;">
            <button id="do-login" class="btn" style="width: 100%;">Login</button>
            <button onclick="document.getElementById('login-modal').style.display='none'" class="btn btn-danger" style="width: 100%; margin-top: 5px;">Cancel</button>
        </div>
    </div>

    <div id="action-modal" class="modal">
        <div class="modal-content">
            <h3 id="action-title">Peer Action</h3>
            <p id="action-peer-id"></p>
            <button id="btn-disconnect" class="btn" style="width: 100%; margin-bottom: 5px;">Disconnect</button>
            <button id="btn-ban" class="btn btn-danger" style="width: 100%; margin-bottom: 5px;">Ban Host & ID</button>
            <button onclick="document.getElementById('action-modal').style.display='none'" class="btn" style="width: 100%; background: #95a5a6;">Cancel</button>
        </div>
    </div>

    <script>
        let isAdmin = false;
        let network = null;
        let vis_nodes = new vis.DataSet([]);
        let vis_edges = new vis.DataSet([]);
        let selectedPeer = null;

        function getAuthToken() {
            return localStorage.getItem('ipx_jwt_token');
        }

        function setAuthToken(token) {
            if (token) {
                localStorage.setItem('ipx_jwt_token', token);
            } else {
                localStorage.removeItem('ipx_jwt_token');
            }
        }

        async function authFetch(url, options = {}) {
            const token = getAuthToken();
            if (token) {
                if (!options.headers) options.headers = {};
                options.headers['Authorization'] = 'Bearer ' + token;
            }
            const resp = await fetch(url, options);
            if (resp.status === 401) {
                setAuthToken(null);
                isAdmin = false;
                updateAdminUI();
            }
            return resp;
        }

        function updateAdminUI() {
            if (isAdmin) {
                document.getElementById('login-btn').style.display = 'none';
                document.getElementById('admin-status').style.display = 'inline';
                document.getElementById('admin-config-area').style.display = 'block';
                const adminHeaders = document.querySelectorAll('.admin-only-header');
                adminHeaders.forEach(h => h.style.display = 'table-cell');
            } else {
                document.getElementById('login-btn').style.display = 'inline';
                document.getElementById('admin-status').style.display = 'none';
                document.getElementById('admin-config-area').style.display = 'none';
                const adminHeaders = document.querySelectorAll('.admin-only-header');
                adminHeaders.forEach(h => h.style.display = 'none');
            }
            // Trigger table update to show/hide manage buttons
            loadStats();
        }

        function initGraph() {
            const container = document.getElementById('network-graph');
            const data = { nodes: vis_nodes, edges: vis_edges };
            const options = {
                nodes: { shape: 'dot', size: 16, font: { size: 12 } },
                edges: { arrows: 'to' },
                physics: { stabilization: true }
            };
            network = new vis.Network(container, data, options);
            network.on("click", function (params) {
                if (params.nodes.length > 0) {
                    const peerId = params.nodes[0];
                    if (peerId === 'Local') return;
                    if (isAdmin) {
                        showActionModal(peerId);
                    }
                }
            });
        }

        function showActionModal(peerId) {
            selectedPeer = peerId;
            document.getElementById('action-title').textContent = "Action for " + peerId;
            document.getElementById('action-modal').style.display = 'block';
        }

        async function setSort(field) {
            await authFetch('/api/sort?field=' + field);
            loadStats();
        }

        async function loadStats() {
            try {
                const resp = await authFetch('/stats');
                const data = await resp.json();

                document.getElementById('total-received').textContent = data.total_received;
                document.getElementById('total-forwarded').textContent = data.total_forwarded;
                document.getElementById('total-dropped').textContent = data.total_dropped;
                document.getElementById('total-errors').textContent = data.total_errors;
                document.getElementById('uptime').textContent = data.uptime_str;
                document.getElementById('listen-addr').textContent = data.listen_addr;
                document.getElementById('peer-count').textContent = data.peers ? data.peers.length : 0;

                if (data.demo_props) {
                    document.getElementById('demo-area').style.display = 'block';
                    updateInputIfNoFocus('demo-pkt-rate', data.demo_props.packet_rate);
                    updateInputIfNoFocus('demo-drop-rate', data.demo_props.drop_rate);
                    updateInputIfNoFocus('demo-err-rate', data.demo_props.error_rate);
                    updateInputIfNoFocus('demo-num-peers', data.demo_props.num_peers);
                }

                updateInputIfNoFocus('admin-max-children', data.max_children || 5);
                updateInputIfNoFocus('admin-network-key', data.network_key || '');
                updateInputIfNoFocus('admin-rebalance-interval', data.rebalance_interval || 30);
                document.getElementById('admin-rebalance-enabled').checked = data.rebalance_enabled;

                updateLogs(data.logs);
                updateTable(data.peers);
                updateGraph(data.peers);
            } catch (e) {
                console.error("Failed to load stats:", e);
            }
        }

        // Add resize observer to network graph for vis.js
        const resizeObserver = new ResizeObserver(() => {
            if (network) network.setSize('100%', '100%');
        });
        resizeObserver.observe(document.getElementById('network-graph'));

        function updateLogs(logs) {
            const logArea = document.getElementById('log-area');
            if (!logs) return;
            const isAtBottom = logArea.scrollHeight - logArea.scrollTop <= logArea.clientHeight + 1;
            
            logArea.innerHTML = '';
            logs.forEach(l => {
                const div = document.createElement('div');
                const ts = new Date(l.timestamp).toLocaleTimeString();
                const levelClass = 'log-' + l.level.toLowerCase();
                div.innerHTML = `<span class="log-timestamp">[${ts}]</span><span class="${levelClass}">${l.level}: ${l.message}</span>`;
                logArea.appendChild(div);
            });

            if (isAtBottom) {
                logArea.scrollTop = logArea.scrollHeight;
            }
        }

        function updateTable(peers) {
            const tbody = document.getElementById('peer-table-body');
            tbody.innerHTML = '';
            if (!peers || peers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11">No peers connected.</td></tr>';
                return;
            }
            peers.forEach(p => {
	const tr = document.createElement('tr');
	let consumption = 0;
	if (p.max_children > 0) {
		consumption = (p.num_children / p.max_children * 100).toFixed(1);
	}
	tr.innerHTML = `
		<td>${p.id}</td>
		<td>${p.ip}</td>
		<td>${p.hostname}</td>
		<td>${p.latency_ms.toFixed(1)} ms</td>
		<td>${formatTime(p.connected_at)}</td>
		<td>${formatTimeAgo(p.last_seen)}</td>
		<td>${p.num_children}/${p.max_children} (${consumption}%)</td>
		<td>${formatBytes(p.sent_bytes)}</td>
		<td>${formatBytes(p.recv_bytes)}</td>
		<td>${p.sent_pkts}</td>
		<td>${p.recv_pkts}</td>
		<td>${p.errors}</td>
		<td style="display: ${isAdmin ? 'table-cell' : 'none'}">
			<button class="btn btn-danger" onclick="showActionModal('${p.id}')">Manage</button>
		</td>
	`;
	tbody.appendChild(tr);
            });
        }

        function updateGraph(peers) {
            if (!network) initGraph();
            
            const currentNodes = [{ id: 'Local', label: 'Local Node', color: '#2ecc71', level: 0 }];
            const currentEdges = [];

            if (peers) {
                peers.forEach((p, index) => {
                    currentNodes.push({ id: p.id, label: p.hostname || p.id });
                    
                    // Use parent_id for hierarchical topology if available
                    let parent = p.parent_id || 'Local';
                    
                    // Connection to Parent
                    currentEdges.push({ 
                        id: parent + '-' + p.id, 
                        from: parent, 
                        to: p.id, 
                        label: formatBytes(p.sent_bytes),
                        font: { size: 10, color: '#666' }
                    });
                });
            }

            vis_nodes.update(currentNodes);
            vis_edges.update(currentEdges);
            
            // Remove old nodes
            const nodeIds = vis_nodes.getIds();
            const peerIds = peers ? peers.map(p => p.id) : [];
            nodeIds.forEach(id => {
                if (id !== 'Local' && !peerIds.includes(id)) {
                    vis_nodes.remove(id);
                }
            });
        }

        function formatBytes(b) {
            if (b < 1024) return b + " B";
            if (b < 1024*1024) return (b/1024).toFixed(1) + " KB";
            return (b/(1024*1024)).toFixed(1) + " MB";
        }

        function formatTimeAgo(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffSec = Math.round(diffMs / 1000);
            if (diffSec < 0) return "0s";
            if (diffSec < 60) return diffSec + "s";
            if (diffSec < 3600) return Math.floor(diffSec / 60) + "m " + (diffSec % 60) + "s";
            return Math.floor(diffSec / 3600) + "h " + Math.floor((diffSec % 3600) / 60) + "m";
        }

        function formatTime(dateStr) {
            const date = new Date(dateStr);
            return date.getHours().toString().padStart(2, '0') + ":" + 
                   date.getMinutes().toString().padStart(2, '0') + ":" + 
                   date.getSeconds().toString().padStart(2, '0');
        }

        function updateInputIfNoFocus(id, value) {
            const el = document.getElementById(id);
            if (document.activeElement !== el) {
                el.value = value;
            }
        }

        document.getElementById('login-btn').onclick = () => {
            document.getElementById('login-modal').style.display = 'block';
        };

        document.getElementById('do-login').onclick = async () => {
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            const resp = await fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user, pass })
            });
            const res = await resp.json();
            if (res.success) {
                isAdmin = true;
                setAuthToken(res.token);
                document.getElementById('login-modal').style.display = 'none';
                updateAdminUI();
            } else {
                showToast("Login failed", "error");
            }
        };

        function showToast(message, type) {
            // Simple toast instead of alert
            const logArea = document.getElementById('log-area');
            const div = document.createElement('div');
            const ts = new Date().toLocaleTimeString();
            const levelClass = type === 'error' ? 'log-error' : 'log-info';
            div.innerHTML = `<span class="log-timestamp">[${ts}]</span><span class="${levelClass}">${type.toUpperCase()}: ${message}</span>`;
            logArea.appendChild(div);
            logArea.scrollTop = logArea.scrollHeight;
        }

        document.getElementById('apply-demo').onclick = async () => {
            const props = {
                packet_rate: parseInt(document.getElementById('demo-pkt-rate').value),
                drop_rate: parseInt(document.getElementById('demo-drop-rate').value),
                error_rate: parseInt(document.getElementById('demo-err-rate').value),
                num_peers: parseInt(document.getElementById('demo-num-peers').value)
            };
            await authFetch('/api/demo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(props)
            });
            loadStats();
        };

        document.getElementById('apply-config').onclick = async () => {
            const pass = document.getElementById('new-admin-pass').value;
            const networkKey = document.getElementById('admin-network-key').value;
            const maxChildren = parseInt(document.getElementById('admin-max-children').value);
            const rebalanceEnabled = document.getElementById('admin-rebalance-enabled').checked;
            const rebalanceInterval = parseInt(document.getElementById('admin-rebalance-interval').value);
            
            const body = {
                rebalance_enabled: rebalanceEnabled,
                rebalance_interval: rebalanceInterval
            };
            if (pass) body.admin_pass = pass;
            if (networkKey !== undefined) body.network_key = networkKey;
            if (!isNaN(maxChildren)) body.max_children = maxChildren;
            
            const resp = await authFetch('/api/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const res = await resp.json();
            if (res.success) {
                document.getElementById('new-admin-pass').value = '';
                showToast("Settings updated successfully", "info");
            } else {
                showToast("Failed to update settings", "error");
            }
        };

        document.getElementById('add-peer-btn').onclick = async () => {
            const addr = document.getElementById('manual-peer-addr').value;
            if (!addr) return;
            
            const resp = await authFetch('/api/peers/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ addr })
            });
            const res = await resp.json();
            if (res.success) {
                document.getElementById('manual-peer-addr').value = '';
                showToast("Peer added successfully", "info");
                loadStats();
            } else {
                showToast("Failed to add peer", "error");
            }
        };

        async function performAction(action) {
            await authFetch('/api/action', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, id: selectedPeer })
            });
            document.getElementById('action-modal').style.display = 'none';
            loadStats();
        }

        document.getElementById('btn-disconnect').onclick = () => performAction('disconnect');
        document.getElementById('btn-ban').onclick = () => performAction('ban');

        // Initialize and check existing auth
        if (getAuthToken()) {
            isAdmin = true;
            updateAdminUI();
        } else {
            loadStats();
        }
        setInterval(loadStats, 3000);
    </script>
</body>
</html>
